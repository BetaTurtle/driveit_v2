<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DriveIt</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #18222d;
            --tg-theme-text-color: #ffffff;
            --tg-theme-button-color: #2ea6ff;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #131415;
        }

        body {
            margin: 0;
            padding: 16px;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-family: -apple-system, system-ui, sans-serif;
            line-height: 1.5;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
        }

        .title {
            font-size: 20px;
            font-weight: 600;
            text-align: center;
            margin: 0 0 24px;
        }

        .status-list {
            text-align: left;
        }

        .welcome-msg {
            font-size: 16px;
        }

        .highlight {
            color: var(--tg-theme-button-color);
            font-weight: 600;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--tg-theme-hint-color);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loader {
            flex-shrink: 0;
            width: 14px;
            height: 14px;
            border: 2px solid var(--tg-theme-button-color);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.6s linear infinite;
        }

        .checkmark {
            flex-shrink: 0;
            color: #34d399;
            font-size: 16px;
        }

        a {
            color: var(--tg-theme-button-color);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .success-message {
            margin-top: 24px;
            padding: 16px;
            background: rgba(52, 211, 153, 0.1);
            border-radius: 8px;
            color: #34d399;
            text-align: center;
        }

        .text-sm { font-size: 14px; }
        .hidden { display: none; }
        .mb-3 { margin-bottom: 12px; }
        .mt-3 { margin-top: 12px; }
        .error { 
            color: #ef5b5b;
            text-align: center;
        }
    </style>

    <script>
    // Apply Telegram theme
    (function(){
        const tg = window.Telegram?.WebApp;
        if (!tg) return;
        
        const vars = {
            bg_color: '--tg-theme-bg-color',
            text_color: '--tg-theme-text-color',
            button_color: '--tg-theme-button-color',
            button_text_color: '--tg-theme-button-text-color',
            secondary_bg_color: '--tg-theme-secondary-bg-color'
        };

        function applyTheme(params) {
            if (!params) return;
            const root = document.documentElement;
            for (const [key, cssVar] of Object.entries(vars)) {
                if (params[key]) root.style.setProperty(cssVar, params[key]);
            }
        }

        applyTheme(tg.themeParams || tg.theme);
        if (tg.onEvent) tg.onEvent('themeChanged', applyTheme);
    })();
    </script>
</head>
<body>
    <div class="container">
        <h1 class="title mb-3">DriveIt Telegram Bot</h1>
        
        <div class="status-list">
            <div class="welcome-msg mb-3">
                Welcome <span id="user-name" class="highlight">...</span>
            </div>

            <div class="status-item mb-3">
                <span id="login-status">Logging in...</span>
                <span id="login-loader" class="loader"></span>
                <span id="login-check" class="checkmark hidden">✓</span>
            </div>

            <div class="status-item mb-3">
                <span id="drive-status">Checking Google Drive connection...</span>
                <span id="drive-loader" class="loader"></span>
                <a id="drive-link" class="hidden" href="#">Connect Google Drive</a>
                <span id="drive-check" class="checkmark hidden">✓</span>
            </div>
        </div>

        <div id="success-msg" class="success-message hidden">
            You can now send any file to DriveItBot and I will upload it to your Google Drive
            <div class="text-sm mt-3">Just forward files to @DriveItBot</div>
        </div>

        <button id="logout-button" style="margin-top: 12px; width: 100%; padding: 10px; background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border: none; border-radius: 8px; font-size: 16px; cursor: pointer;" class="hidden">Logout</button>
        
        <div id="error" class="text-sm error hidden"></div>
    </div>

    <script>
    const CONFIG = {
        firebase: {
            apiKey: "AIzaSyAIY6BkbO6gRLMcLuOgtIBvwI4J1y2CHcw",
            authDomain: "aerial-episode-125308.firebaseapp.com",
            projectId: "aerial-episode-125308",
            appId: "1:224314386927:web:08bdead70144111af9ee1a"
        },
        auth: {
            backend: "https://driveit-v.deno.dev/authenticate",
            redirectUri: "https://betaturtle.github.io/driveit_v2/redir.html",
            // backend: "http://127.0.0.1:3000/authenticate",
            // redirectUri: "https://betaturtle.github.io/driveit_v2/redir.html",
            clientId: "224314386927-kb90emu5vr086murg5ea0bmfod8tqlep.apps.googleusercontent.com"
        }
    };

    const UI = {
        userName: document.getElementById('user-name'),
        loginStatus: document.getElementById('login-status'),
        loginLoader: document.getElementById('login-loader'),
        loginCheck: document.getElementById('login-check'),
        driveStatus: document.getElementById('drive-status'),
        driveLoader: document.getElementById('drive-loader'),
        driveCheck: document.getElementById('drive-check'),
        driveLink: document.getElementById('drive-link'),
        successMsg: document.getElementById('success-msg'),
        error: document.getElementById('error'),
        
        setLoginState(state) {
            switch(state) {
                case 'loading':
                    this.loginStatus.textContent = 'Logging in...';
                    this.loginLoader.classList.remove('hidden');
                    this.loginCheck.classList.add('hidden');
                    break;
                case 'done':
                    this.loginStatus.textContent = 'Logged in';
                    this.loginLoader.classList.add('hidden');
                    this.loginCheck.classList.remove('hidden');
                    break;
                case 'error':
                    this.loginStatus.textContent = 'Login failed';
                    this.loginLoader.classList.add('hidden');
                    this.loginCheck.classList.add('hidden');
            }
        },
        
        setDriveState(state, email = null) {
            switch(state) {
                case 'checking':
                    this.driveStatus.textContent = 'Checking Google Drive connection...';
                    this.driveLoader.classList.remove('hidden');
                    this.driveCheck.classList.add('hidden');
                    this.driveLink.classList.add('hidden');
                    break;
                case 'connected':
                    this.driveStatus.textContent = `Connected to ${email}`;
                    this.driveLoader.classList.add('hidden');
                    this.driveCheck.classList.remove('hidden');
                    this.driveLink.classList.add('hidden');
                    this.successMsg.classList.remove('hidden');
                    document.getElementById('logout-button').classList.remove('hidden');
                    break;
                case 'need_auth':
                    this.driveStatus.textContent = 'Not connected';
                    this.driveLoader.classList.add('hidden');
                    this.driveCheck.classList.add('hidden');
                    this.driveLink.classList.remove('hidden');
                    break;
            }
        },
        
        showError(msg) {
            this.error.textContent = msg;
            this.error.classList.remove('hidden');
            this.setLoginState('error');
            this.successMsg.classList.add('hidden');
        }
    };

    function decodeBase64Url(str) {
        if (!str) return null;
        try {
            const base64 = str.replace(/-/g, '+').replace(/_/g, '/') + '='.repeat((4 - str.length % 4) % 4);
            return new TextDecoder().decode(Uint8Array.from(atob(base64), c => c.charCodeAt(0)));
        } catch (e) {
            return null;
        }
    }

    function buildAuthUrl() {
        const params = new URLSearchParams({
            client_id: CONFIG.auth.clientId,
            redirect_uri: CONFIG.auth.redirectUri,
            response_type: 'code',
            scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email',
            include_granted_scopes: 'true',
            prompt: 'consent',
            access_type: 'offline',
            state: Math.random().toString(36).slice(2)
        });
        return `https://accounts.google.com/o/oauth2/v2/auth?${params}`;
    }

    async function authenticate(initData, googleCode) {
        console.log("making api call");
        const userName = window.Telegram.WebApp.initDataUnsafe.user.first_name;
        UI.userName.textContent = userName;
        UI.setLoginState('loading');
        UI.setDriveState('checking');
        var gC = { code: googleCode, redirect_uri: CONFIG.auth.redirectUri };
        console.log("googleCode");
        console.log(gC);
        try {
            // Backend authentication
            const res = await fetch(CONFIG.auth.backend, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    initData,
                    googleAuth: googleCode ? { code: googleCode, redirect_uri: CONFIG.auth.redirectUri } : undefined
                })
            });
            
            const data = await res.json();
            console.log(data);
            if (!res.ok) throw new Error(data.error || `Server error: ${res.status}`);
            if (!data.customToken) throw new Error('No auth token received');

            // Firebase auth
            const fb = firebase.initializeApp(CONFIG.firebase);
            const { user } = await fb.auth().signInWithCustomToken(data.customToken);
            UI.setLoginState('done');
            console.log("set login state to done");
            
            // Save minimal user data
            const doc = fb.firestore().collection('users').doc(user.uid);
            const userData = {
                telegram_id: window.Telegram.WebApp.initDataUnsafe.user.id,
                last_login: firebase.firestore.FieldValue.serverTimestamp()
            };

            
            
            if (data.google?.email) {
                Object.assign(userData, {
                    google_email: data.google.email,
                    credentials: {
                        access_token: data.google.access_token,
                        refresh_token: data.google.refresh_token,
                        expires_in: data.google.expires_in,
                        obtained_at: Date.now()
                    }
                });
            }
            
            
            await doc.set(userData, { merge: true });

            console.log("first set of saving done");
            
            // Check Drive connection
            const snapshot = await doc.get();
            const email = snapshot.data()?.google_email;
            
            if (email) {
                UI.setDriveState('connected', email);
            } else {
                UI.setDriveState('need_auth');
                UI.driveLink.href = buildAuthUrl();
            }
            
        } catch (err) {
            console.error(err);
            UI.showError(err.message);
        }
    }

    async function logout() {
        try {
            const fb = firebase.app();
            const user = fb.auth().currentUser;
            if (user) {
                const docRef = fb.firestore().collection('users').doc(user.uid);
                await docRef.update({
                    google_email: firebase.firestore.FieldValue.delete(),
                    credentials: firebase.firestore.FieldValue.delete()
                });
                await fb.auth().signOut();
                window.location.reload();
            }
        } catch (err) {
            console.error('Logout failed:', err);
            UI.showError('Logout failed: ' + err.message);
        }
    }

    // Main
    const tg = window.Telegram?.WebApp;
    if (!tg || !tg.initData || !tg.initDataUnsafe?.user) {
        UI.showError('Not running in Telegram');
    } else {
        tg.ready();
        tg.expand();
        
        document.getElementById('logout-button').onclick = logout;

        UI.driveLink.onclick = (e) => {
            e.preventDefault();
            window.open(buildAuthUrl(), '_blank');
        };
        var url;
        // url = "NC8wQVZHelIxRFpqNkdKUzFOSDVXc0NNbG1ZVHRFMDFTQmFxc3dOZ1YzMGI1bFNtMmJlZGFRMkFfMXVhWW9BLVN5QjVEU3VHQQ";
        // url = decodeBase64Url(url);
        url = decodeBase64Url(tg.initDataUnsafe.start_param)
        
        authenticate(tg.initData, url);
    }
    </script>

</body>
</html>